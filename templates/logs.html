
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1><i class="bi bi-file-text"></i> System Logs</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="bi bi-activity"></i> Log-Einträge</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadLogs()" title="Aktualisieren">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-warning" onclick="clearLogs()" title="Logs löschen">
                        <i class="bi bi-trash"></i>
                    </button>
                    <div class="form-check form-switch d-inline-block ms-2">
                        <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                        <label class="form-check-label" for="autoRefresh">Auto-Update</label>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="filterLevel" class="form-label">Log-Level Filter:</label>
                    <select class="form-select form-select-sm d-inline-block w-auto" id="filterLevel">
                        <option value="">Alle</option>
                        <option value="DEBUG">DEBUG</option>
                        <option value="INFO">INFO</option>
                        <option value="WARNING">WARNING</option>
                        <option value="ERROR">ERROR</option>
                    </select>
                    
                    <input type="text" class="form-control form-control-sm d-inline-block w-auto ms-2" 
                           id="filterText" placeholder="Text filtern..." style="width: 200px !important;">
                </div>
                
                <div id="logs-container" class="log-container" style="max-height: 600px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
let allLogs = [];
let autoRefreshInterval = null;

function loadLogs() {
    fetch('/api/logs')
        .then(response => response.json())
        .then(logs => {
            allLogs = logs;
            filterAndDisplayLogs();
        })
        .catch(error => {
            console.error('Error loading logs:', error);
            document.getElementById('logs-container').innerHTML = '<p class="text-danger">Fehler beim Laden der Logs</p>';
        });
}

function filterAndDisplayLogs() {
    const levelFilter = document.getElementById('filterLevel').value;
    const textFilter = document.getElementById('filterText').value.toLowerCase();
    
    let filteredLogs = allLogs;
    
    if (levelFilter) {
        filteredLogs = filteredLogs.filter(log => log.level === levelFilter);
    }
    
    if (textFilter) {
        filteredLogs = filteredLogs.filter(log => 
            log.message.toLowerCase().includes(textFilter) ||
            log.module.toLowerCase().includes(textFilter)
        );
    }
    
    let logsHtml = '';
    if (filteredLogs.length > 0) {
        filteredLogs.forEach(log => {
            const levelClass = `log-${log.level.toLowerCase()}`;
            const levelIcon = getLevelIcon(log.level);
            logsHtml += `
                <div class="log-entry ${levelClass}">
                    <i class="bi ${levelIcon}"></i>
                    <strong>[${log.timestamp}]</strong>
                    <span class="badge bg-secondary">${log.level}</span>
                    <span class="text-muted">${log.module}:</span>
                    ${log.message}
                </div>
            `;
        });
    } else {
        logsHtml = '<em class="text-muted">Keine Logs entsprechen den Filterkriterien</em>';
    }
    
    document.getElementById('logs-container').innerHTML = logsHtml;
    
    // Auto-scroll to bottom
    const container = document.getElementById('logs-container');
    container.scrollTop = container.scrollHeight;
}

function getLevelIcon(level) {
    switch (level) {
        case 'DEBUG': return 'bi-bug';
        case 'INFO': return 'bi-info-circle';
        case 'WARNING': return 'bi-exclamation-triangle';
        case 'ERROR': return 'bi-x-circle';
        default: return 'bi-circle';
    }
}

function clearLogs() {
    if (confirm('Sind Sie sicher, dass Sie alle Logs löschen möchten?')) {
        fetch('/api/logs/clear', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                allLogs = [];
                filterAndDisplayLogs();
                showAlert('success', data.message);
            } else {
                showAlert('danger', 'Fehler beim Löschen der Logs');
            }
        })
        .catch(error => {
            console.error('Error clearing logs:', error);
            showAlert('danger', 'Fehler beim Löschen der Logs');
        });
    }
}

function toggleAutoRefresh() {
    const autoRefresh = document.getElementById('autoRefresh').checked;
    
    if (autoRefresh) {
        autoRefreshInterval = setInterval(loadLogs, 2000);
    } else {
        if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
        }
    }
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.container').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// Event listeners
document.getElementById('filterLevel').addEventListener('change', filterAndDisplayLogs);
document.getElementById('filterText').addEventListener('input', filterAndDisplayLogs);
document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);

// Load logs on page load
loadLogs();
toggleAutoRefresh();
{% endblock %}
