
{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1><i class="bi bi-speedometer2"></i> BSSCI System Status</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-router"></i> Verbundene Basisstationen</h5>
            </div>
            <div class="card-body">
                <div id="basestation-count" class="h4 text-primary">
                    <i class="bi bi-hourglass-split"></i> Lade...
                </div>
                <div id="basestation-list"></div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-wifi"></i> MQTT Status</h5>
            </div>
            <div class="card-body">
                <div id="mqtt-status" class="h4">
                    <i class="bi bi-hourglass-split"></i> Lade...
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="bi bi-activity"></i> Aktuelle Logs</h5>
            </div>
            <div class="card-body">
                <div id="recent-logs" class="log-container" style="max-height: 300px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
function loadStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('basestation-count').innerHTML = 
                `<i class="bi bi-router"></i> ${data.connected_count} Basisstation(en) verbunden`;
            
            let listHtml = '';
            data.base_stations.forEach(bs => {
                listHtml += `
                    <div class="border-bottom py-2">
                        <strong>EUI:</strong> ${bs.eui}<br>
                        <small class="text-muted">Adresse: ${bs.address}</small>
                    </div>
                `;
            });
            document.getElementById('basestation-list').innerHTML = listHtml || '<em class="text-muted">Keine Basisstationen verbunden</em>';
            
            document.getElementById('mqtt-status').innerHTML = data.mqtt_connected ? 
                '<i class="bi bi-check-circle text-success"></i> MQTT Verbunden' : 
                '<i class="bi bi-x-circle text-danger"></i> MQTT Getrennt';
        })
        .catch(error => {
            console.error('Error loading status:', error);
            document.getElementById('basestation-count').innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> Fehler beim Laden';
        });
}

function loadRecentLogs() {
    fetch('/api/logs')
        .then(response => response.json())
        .then(logs => {
            let logsHtml = '';
            logs.slice(-10).forEach(log => {
                const levelClass = `log-${log.level.toLowerCase()}`;
                logsHtml += `
                    <div class="log-entry ${levelClass}">
                        [${log.timestamp}] ${log.level} - ${log.module}: ${log.message}
                    </div>
                `;
            });
            document.getElementById('recent-logs').innerHTML = logsHtml || '<em class="text-muted">Keine Logs verf√ºgbar</em>';
            
            // Auto-scroll to bottom
            const container = document.getElementById('recent-logs');
            container.scrollTop = container.scrollHeight;
        })
        .catch(error => console.error('Error loading logs:', error));
}

// Load data on page load
loadStatus();
loadRecentLogs();

// Refresh every 5 seconds
setInterval(() => {
    loadStatus();
    loadRecentLogs();
}, 5000);
{% endblock %}
