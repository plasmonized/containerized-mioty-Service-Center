{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>BSSCI Service Center Dashboard</h1>
        <div id="service-status" class="alert alert-info" role="alert">
            <strong>Service Status</strong><br>
            <div id="service-details">Loading service status...</div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('sensors') }}" class="btn btn-primary btn-block mb-2">Manage Sensors</a>
                <a href="{{ url_for('config') }}" class="btn btn-secondary btn-block mb-2">Configuration</a>
                <a href="{{ url_for('logs') }}" class="btn btn-info btn-block">View Logs</a>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5>Base Station Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Connected Base Stations: <span id="connected-count" class="badge badge-success">0</span></h6>
                        <div id="connected-stations"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Connecting Base Stations: <span id="connecting-count" class="badge badge-warning">0</span></h6>
                        <div id="connecting-stations"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Recent Logs</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="recent-logs">
                    Loading logs...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateServiceStatus() {
            fetch('/api/bssci/status')
                .then(response => response.json())
                .then(data => {
                    const statusDiv = document.getElementById('service-status');
                    const detailsDiv = document.getElementById('service-details');

                    if (data.running) {
                        statusDiv.className = 'alert alert-success';

                        let statusHtml = `
                            <div class="row">
                                <div class="col-md-4">
                                    <strong>TLS Server:</strong><br>
                                    <span class="badge bg-${data.tls_server.active ? 'success' : 'danger'}">
                                        ${data.tls_server.active ? 'Active' : 'Inactive'}
                                    </span><br>
                                    <small>Port: ${data.tls_server.listening_port || 'N/A'}</small><br>
                                    <small>Base Stations: ${data.tls_server.connected_base_stations}</small><br>
                                    <small>Sensors: ${data.tls_server.registered_sensors}/${data.tls_server.total_sensors}</small>
                                </div>
                                <div class="col-md-4">
                                    <strong>MQTT Broker:</strong><br>
                                    <span class="badge bg-${data.mqtt_broker.connected ? 'success' : 'danger'}">
                                        ${data.mqtt_broker.connected ? 'Connected' : 'Disconnected'}
                                    </span><br>
                                    <small>${data.mqtt_broker.broker_host}:${data.mqtt_broker.broker_port}</small><br>
                                    <small>Topic: ${data.mqtt_broker.base_topic}</small><br>
                                    <small>Queues: ${data.mqtt_broker.out_queue_size}/${data.mqtt_broker.in_queue_size}</small>
                                </div>
                            </div>
                        `;
                        detailsDiv.innerHTML = statusHtml;
                    } else {
                        statusDiv.className = 'alert alert-danger';
                        detailsDiv.innerHTML = `
                            <strong>Service Error:</strong> ${data.error || 'Unknown error'}
                            <div class="mt-2">
                                <small>TLS Server: ${data.tls_server.active ? 'Active' : 'Inactive'}</small><br>
                                <small>MQTT Broker: ${data.mqtt_broker.active ? 'Active' : 'Inactive'}</small>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('Error fetching service status:', error);
                    document.getElementById('service-status').className = 'alert alert-warning';
                    document.getElementById('service-details').innerHTML = 'Failed to load service status';
                });
        }

function loadBaseStationStatus() {
    fetch('/api/base_stations')
        .then(response => response.json())
        .then(data => {
            // Update connected count
            document.getElementById('connected-count').textContent = data.total_connected;
            document.getElementById('connecting-count').textContent = data.total_connecting;

            // Update connected base stations list
            const connectedDiv = document.getElementById('connected-stations');
            if (data.connected.length === 0) {
                connectedDiv.innerHTML = '<small class="text-muted">No base stations connected</small>';
            } else {
                const connectedHtml = data.connected.map(bs => 
                    `<div class="mb-1">
                        <small><code>${bs.eui}</code> <span class="badge bg-success">Connected</span></small>
                    </div>`
                ).join('');
                connectedDiv.innerHTML = connectedHtml;
            }

            // Update connecting base stations list
            const connectingDiv = document.getElementById('connecting-stations');
            if (data.connecting.length === 0) {
                connectingDiv.innerHTML = '<small class="text-muted">No base stations connecting</small>';
            } else {
                const connectingHtml = data.connecting.map(bs => 
                    `<div class="mb-1">
                        <small><code>${bs.eui}</code> <span class="badge bg-warning">Connecting</span></small>
                    </div>`
                ).join('');
                connectingDiv.innerHTML = connectingHtml;
            }
        })
        .catch(error => {
            document.getElementById('connected-stations').innerHTML = '<small class="text-danger">Error loading status</small>';
            document.getElementById('connecting-stations').innerHTML = '<small class="text-danger">Error loading status</small>';
        });
}

function loadRecentLogs() {
    fetch('/api/logs?limit=10')
        .then(response => response.json())
        .then(data => {
            const logsDiv = document.getElementById('recent-logs');
            const logs = data.logs || [];

            if (logs.length === 0) {
                logsDiv.innerHTML = '<p class="text-muted">Recent logs will appear here when available</p>';
                return;
            }

            const logHtml = logs.slice(-10).map(log => 
                `<div class="log-entry mb-1">
                    <small class="text-muted">${log.timestamp}</small>
                    <span class="badge" style="background-color: ${log.level.toLowerCase() === 'error' ? '#dc3545' : 
                                                log.level.toLowerCase() === 'warning' ? '#ff8c00' : '#6c757d'}; color: white;">${log.level}</span>
                    <strong>${log.logger}:</strong> ${log.message}
                </div>`
            ).join('');

            logsDiv.innerHTML = logHtml;
        })
        .catch(error => {
            console.error('Failed to load logs:', error);
            document.getElementById('recent-logs').innerHTML = '<p class="text-muted">Recent logs will appear here when available</p>';
        });
}

// Update service status and base stations every 5 seconds
        updateServiceStatus();
        loadBaseStationStatus();
        loadRecentLogs();
        setInterval(() => {
            updateServiceStatus();
            loadBaseStationStatus();
        }, 5000);
</script>
{% endblock %}