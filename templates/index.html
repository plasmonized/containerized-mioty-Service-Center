{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>BSSCI Service Center Dashboard</h1>
        <div id="service-status" class="alert alert-info" role="alert">
            <strong>Service Status</strong><br>
            <div id="service-details">Loading service status...</div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('sensors') }}" class="btn btn-primary btn-block mb-2">Manage Sensors</a>
                <a href="{{ url_for('config') }}" class="btn btn-secondary btn-block mb-2">Configuration</a>
                <a href="{{ url_for('logs') }}" class="btn btn-info btn-block">View Logs</a>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5>Base Station Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Connected Base Stations: <span id="connected-count" class="badge badge-success">0</span></h6>
                        <div id="connected-stations"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Connecting Base Stations: <span id="connecting-count" class="badge badge-warning">0</span></h6>
                        <div id="connecting-stations"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Recent Logs</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="recent-logs">
                    Loading logs...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateServiceStatus() {
            fetch('/api/bssci/status')
                .then(response => response.json())
                .then(data => {
                    document.getElementById('service-status').className =
                        data.running ? 'alert alert-success' : 'alert alert-warning';

                    const serviceTypeText = data.service_type ?
                        ` (${data.service_type.charAt(0).toUpperCase() + data.service_type.slice(1)} Mode)` : '';

                    document.getElementById('service-details').innerHTML = data.running ?
                        `The BSSCI Service Center is running and ready to accept base station connections${serviceTypeText}.
                            <ul class="list-unstyled mt-2 mb-0">
                                <li><strong>TLS Server:</strong> ${data.tls_server.active ?
                                    `Listening on port ${data.tls_server.listening_port}` : 'Inactive'}</li>
                                <li><strong>MQTT Broker:</strong> ${data.mqtt_broker.active ?
                                    `Connected to ${data.mqtt_broker.broker_host}:${data.mqtt_broker.broker_port}` : 'Inactive'}</li>
                                <li><strong>Base Stations:</strong> ${data.tls_server.connected_base_stations || 0} connected</li>
                                <li><strong>Sensors:</strong> ${data.tls_server.total_sensors || 0} configured, ${data.tls_server.registered_sensors || 0} registered</li>
                            </ul>` :
                        `Service Center has issues - check configuration and logs${serviceTypeText}.
                            <div class="mt-2">
                                <small>TLS Server: ${data.tls_server.active ? 'Active' : 'Inactive'}</small><br>
                                <small>MQTT Broker: ${data.mqtt_broker.active ? 'Active' : 'Inactive'}</small>
                                ${data.error ? `<br><small class="text-danger">Error: ${data.error}</small>` : ''}
                            </div>
                        `;
                })
                .catch(error => {
                    console.error('Error fetching service status:', error);
                    document.getElementById('service-status').className = 'alert alert-warning';
                    document.getElementById('service-details').innerHTML = 'Failed to load service status';
                });
        }

function loadBaseStationStatus() {
    // Fetch from '/api/bssci/status' as per the intention of the changes snippet.
    // The original code fetched from '/api/base_stations'.
    fetch('/api/bssci/status')
        .then(response => response.json())
        .then(data => {
            // Update connected count using the data property suggested by the changes snippet.
            // The original code used 'data.total_connected'.
            const connectedCount = data.tls_server ? data.tls_server.connected_base_stations : 0;
            document.getElementById('connected-count').textContent = connectedCount;

            // The changes snippet does not provide logic for 'connecting-count' or the lists of stations.
            // Also, the API endpoint has changed, so the old data structure might not be available.
            // Therefore, we will update 'connecting-count' and the lists to reflect that this information
            // might not be available from the new API endpoint, or set a placeholder.
            // We are omitting the update for 'base-station-message' as this element does not exist in the original HTML.

            // Setting placeholder/default values for connecting stations as no update logic was provided in the snippet.
            document.getElementById('connecting-count').textContent = 'N/A';
            document.getElementById('connecting-stations').innerHTML = '<small class="text-muted">Connecting station info not available</small>';

            // Similarly, for connected stations list.
            const connectedDiv = document.getElementById('connected-stations');
            connectedDiv.innerHTML = '<small class="text-muted">Detailed connected station lists not available</small>';
        })
        .catch(error => {
            console.error('Error fetching base station status:', error);
            document.getElementById('connected-count').textContent = '0';
            document.getElementById('connecting-count').textContent = 'Error';
            document.getElementById('connected-stations').innerHTML = '<small class="text-danger">Error loading station info</small>';
            document.getElementById('connecting-stations').innerHTML = '<small class="text-danger">Error loading station info</small>';
        });
}

function loadRecentLogs() {
    fetch('/api/logs?limit=10')
        .then(response => response.json())
        .then(data => {
            const logsDiv = document.getElementById('recent-logs');
            const logs = data.logs || [];

            if (logs.length === 0) {
                logsDiv.innerHTML = '<p class="text-muted">Recent logs will appear here when available</p>';
                return;
            }

            const logHtml = logs.slice(-10).map(log =>
                `<div class="log-entry mb-1">
                    <small class="text-muted">${log.timestamp}</small>
                    <span class="badge" style="background-color: ${log.level.toLowerCase() === 'error' ? '#dc3545' :
                                                log.level.toLowerCase() === 'warning' ? '#ff8c00' : '#6c757d'}; color: white;">${log.level}</span>
                    <strong>${log.logger}:</strong> ${log.message}
                </div>`
            ).join('');

            logsDiv.innerHTML = logHtml;
        })
        .catch(error => {
            console.error('Failed to load logs:', error);
            document.getElementById('recent-logs').innerHTML = '<p class="text-muted">Recent logs will appear here when available</p>';
        });
}

// Update service status and base stations every 5 seconds
        updateServiceStatus();
        loadBaseStationStatus();
        loadRecentLogs();
        setInterval(() => {
            updateServiceStatus();
            loadBaseStationStatus();
        }, 5000);
</script>
{% endblock %}