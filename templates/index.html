{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1>BSSCI Service Center Dashboard</h1>
        <div class="alert alert-info">
            <h4>Service Status</h4>
            <p>The BSSCI Service Center is running and ready to accept base station connections.</p>
            <ul>
                <li><strong>TLS Server:</strong> Listening on port {{ config.LISTEN_PORT if config else '16017' }}</li>
                <li><strong>MQTT Broker:</strong> Connected to {{ config.MQTT_BROKER if config else 'akahlig.selfhost.co' }}</li>
            </ul>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('sensors') }}" class="btn btn-primary btn-block mb-2">Manage Sensors</a>
                <a href="{{ url_for('config') }}" class="btn btn-secondary btn-block mb-2">Configuration</a>
                <a href="{{ url_for('logs') }}" class="btn btn-info btn-block">View Logs</a>
            </div>
        </div>
    </div>

    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header">
                <h5>Base Station Status</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Connected Base Stations: <span id="connected-count" class="badge badge-success">0</span></h6>
                        <div id="connected-stations"></div>
                    </div>
                    <div class="col-md-6">
                        <h6>Connecting Base Stations: <span id="connecting-count" class="badge badge-warning">0</span></h6>
                        <div id="connecting-stations"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Recent Logs</h5>
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div id="recent-logs">
                    Loading logs...
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function loadBaseStationStatus() {
    fetch('/api/base_stations')
        .then(response => response.json())
        .then(data => {
            // Update connected count
            document.getElementById('connected-count').textContent = data.total_connected;
            document.getElementById('connecting-count').textContent = data.total_connecting;

            // Update connected base stations list
            const connectedDiv = document.getElementById('connected-stations');
            if (data.connected.length === 0) {
                connectedDiv.innerHTML = '<small class="text-muted">No base stations connected</small>';
            } else {
                const connectedHtml = data.connected.map(bs => 
                    `<div class="mb-1">
                        <small><strong>EUI:</strong> ${bs.eui}</small><br>
                        <small class="text-muted">Address: ${bs.address}</small>
                    </div>`
                ).join('');
                connectedDiv.innerHTML = connectedHtml;
            }

            // Update connecting base stations list
            const connectingDiv = document.getElementById('connecting-stations');
            if (data.connecting.length === 0) {
                connectingDiv.innerHTML = '<small class="text-muted">No base stations connecting</small>';
            } else {
                const connectingHtml = data.connecting.map(bs => 
                    `<div class="mb-1">
                        <small><strong>EUI:</strong> ${bs.eui}</small><br>
                        <small class="text-muted">Address: ${bs.address}</small>
                    </div>`
                ).join('');
                connectingDiv.innerHTML = connectingHtml;
            }
        })
        .catch(error => {
            document.getElementById('connected-stations').innerHTML = '<small class="text-danger">Error loading status</small>';
            document.getElementById('connecting-stations').innerHTML = '<small class="text-danger">Error loading status</small>';
        });
}

function loadRecentLogs() {
    fetch('/api/logs')
        .then(response => response.json())
        .then(logs => {
            const logsDiv = document.getElementById('recent-logs');
            if (logs.length === 0) {
                logsDiv.innerHTML = '<p>No logs available</p>';
                return;
            }

            const logHtml = logs.slice(-10).map(log => 
                `<div class="log-entry mb-1">
                    <small class="text-muted">${log.timestamp}</small>
                    <span class="badge badge-${log.level.toLowerCase() === 'error' ? 'danger' : 
                                                log.level.toLowerCase() === 'warning' ? 'warning' : 'info'}">${log.level}</span>
                    <strong>${log.logger}:</strong> ${log.message}
                </div>`
            ).join('');

            logsDiv.innerHTML = logHtml;
        })
        .catch(error => {
            document.getElementById('recent-logs').innerHTML = '<p>Error loading logs</p>';
        });
}

// Load status and logs on page load and refresh every 5 seconds
loadBaseStationStatus();
loadRecentLogs();
setInterval(loadBaseStationStatus, 5000);
setInterval(loadRecentLogs, 5000);
</script>
{% endblock %}