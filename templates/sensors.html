
{% extends "base.html" %}
{% block title %}Sensors{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Sensor Management</h1>
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sensorModal" onclick="openSensorModal()">
        Add New Sensor
    </button>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>EUI</th>
                        <th>Network Key</th>
                        <th>Short Address</th>
                        <th>Bidirectional</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sensors-table">
                    <!-- Sensors will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Sensor Modal -->
<div class="modal fade" id="sensorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sensorModalTitle">Add New Sensor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sensorForm">
                    <div class="mb-3">
                        <label for="eui" class="form-label">EUI (16 hex characters)</label>
                        <input type="text" class="form-control" id="eui" required maxlength="16">
                    </div>
                    <div class="mb-3">
                        <label for="nwKey" class="form-label">Network Key (32 hex characters)</label>
                        <input type="text" class="form-control" id="nwKey" required maxlength="32">
                    </div>
                    <div class="mb-3">
                        <label for="shortAddr" class="form-label">Short Address (4 hex characters)</label>
                        <input type="text" class="form-control" id="shortAddr" required maxlength="4">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bidi">
                            <label class="form-check-label" for="bidi">
                                Bidirectional
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSensor()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingEui = null;

function loadSensors() {
    fetch('/api/sensors')
        .then(response => response.json())
        .then(sensors => {
            const tbody = document.getElementById('sensors-table');
            tbody.innerHTML = sensors.map(sensor => `
                <tr>
                    <td><code>${sensor.eui}</code></td>
                    <td><code>${sensor.nwKey.substring(0, 8)}...</code></td>
                    <td><code>${sensor.shortAddr}</code></td>
                    <td>${sensor.bidi ? 'Yes' : 'No'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="editSensor('${sensor.eui}')">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteSensor('${sensor.eui}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        });
}

function openSensorModal(sensor = null) {
    editingEui = sensor ? sensor.eui : null;
    document.getElementById('sensorModalTitle').textContent = sensor ? 'Edit Sensor' : 'Add New Sensor';
    
    if (sensor) {
        document.getElementById('eui').value = sensor.eui;
        document.getElementById('nwKey').value = sensor.nwKey;
        document.getElementById('shortAddr').value = sensor.shortAddr;
        document.getElementById('bidi').checked = sensor.bidi;
        document.getElementById('eui').readOnly = true;
    } else {
        document.getElementById('sensorForm').reset();
        document.getElementById('eui').readOnly = false;
    }
}

function editSensor(eui) {
    fetch('/api/sensors')
        .then(response => response.json())
        .then(sensors => {
            const sensor = sensors.find(s => s.eui === eui);
            if (sensor) {
                openSensorModal(sensor);
                new bootstrap.Modal(document.getElementById('sensorModal')).show();
            }
        });
}

function saveSensor() {
    const formData = {
        eui: document.getElementById('eui').value.toUpperCase(),
        nwKey: document.getElementById('nwKey').value.toUpperCase(),
        shortAddr: document.getElementById('shortAddr').value.toUpperCase(),
        bidi: document.getElementById('bidi').checked
    };
    
    fetch('/api/sensors', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('sensorModal')).hide();
            loadSensors();
        } else {
            alert('Error: ' + result.message);
        }
    });
}

function deleteSensor(eui) {
    if (confirm('Are you sure you want to delete this sensor?')) {
        fetch(`/api/sensors/${eui}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                loadSensors();
            } else {
                alert('Error: ' + result.message);
            }
        });
    }
}

// Load sensors on page load
loadSensors();
</script>
{% endblock %}
