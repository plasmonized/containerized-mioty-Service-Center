{% extends "base.html" %}
{% block title %}Sensors{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Sensor Management</h1>
    <div>
        <button class="btn me-2" onclick="reloadSensors()" title="Reload sensor configuration" style="background-color: #6c757d; color: white; border-color: #6c757d;">
            Reload Config
        </button>
        <button type="button" class="btn btn-outline-warning ms-2" onclick="detachAllSensors()">Detach All</button>
        <button type="button" class="btn btn-outline-danger ms-2" onclick="clearAllSensors()">Clear All</button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sensorModal" onclick="openSensorModal()" style="background-color: #ff8c00; border-color: #ff8c00;">
            Add New Sensor
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>EUI</th>
                        <th>Network Key</th>
                        <th>Short Address</th>
                        <th>Bidirectional</th>
                        <th>Registration Status</th>
                        <th>Base Stations</th>
                        <th>Last Activity</th>
                        <th>Preferred Path</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sensors-table">
                    <!-- Sensors will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Sensor Modal -->
<div class="modal fade" id="sensorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sensorModalTitle">Add New Sensor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sensorForm">
                    <div class="mb-3">
                        <label for="eui" class="form-label">EUI (16 hex characters)</label>
                        <input type="text" class="form-control" id="eui" required maxlength="16">
                    </div>
                    <div class="mb-3">
                        <label for="nwKey" class="form-label">Network Key (32 hex characters)</label>
                        <input type="text" class="form-control" id="nwKey" required maxlength="32">
                    </div>
                    <div class="mb-3">
                        <label for="shortAddr" class="form-label">Short Address (4 hex characters)</label>
                        <input type="text" class="form-control" id="shortAddr" required maxlength="4">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bidi">
                            <label class="form-check-label" for="bidi">
                                Bidirectional
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSensor()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingEui = null;

function loadSensors() {
    fetch('/api/sensors')
        .then(response => response.json())
        .then(sensorStatus => {
            const tbody = document.getElementById('sensors-table');
            tbody.innerHTML = Object.values(sensorStatus).map(sensorData => {
                const eui = sensorData.eui;
                let statusBadge = '';
                if (sensorData.registered) {
                    statusBadge = '<span class="badge bg-success">Registered</span>';
                } else {
                    statusBadge = '<span class="badge bg-warning">Not Registered</span>';
                }

                // Registration info with base stations
                let baseStationsText = '';
                if (sensorData.base_stations && sensorData.base_stations.length > 0) {
                    baseStationsText = sensorData.base_stations.join(', ');
                } else {
                    baseStationsText = '-';
                }

                // Last activity display
                let lastActivityText = '-';
                if (sensorData.registration_info && sensorData.registration_info.last_data_time_str) {
                    lastActivityText = sensorData.registration_info.last_data_time_str;
                } else if (sensorData.registration_info && sensorData.registration_info.registration_time) {
                    lastActivityText = `<small class="text-muted">Reg: ${sensorData.registration_info.registration_time}</small>`;
                }

                // Auto-detach warning if sensor is inactive for more than 24 hours
                let activityWarning = '';
                if (sensorData.registration_info && sensorData.registration_info.last_data_timestamp) {
                    const now = Date.now() / 1000;
                    const hoursSinceActivity = (now - sensorData.registration_info.last_data_timestamp) / 3600;
                    if (hoursSinceActivity > 24 && hoursSinceActivity < 48) {
                        activityWarning = '<br><small class="text-warning">‚ö†Ô∏è Inactive >24h</small>';
                    } else if (hoursSinceActivity >= 48) {
                        activityWarning = '<br><small class="text-danger">üïê Auto-detach due</small>';
                    }
                }
                lastActivityText += activityWarning;

                // Preferred path display
                let preferredPathText = '-';
                if (sensorData.preferredDownlinkPath) {
                    const path = sensorData.preferredDownlinkPath;
                    if (path.baseStation) {
                        preferredPathText = `${path.baseStation}<br><small class="text-muted">SNR: ${path.snr}dB (${path.messageCount} msgs)</small>`;
                    }
                }

                return `
                    <tr>
                        <td><code>${sensorData.eui}</code></td>
                        <td><code>${sensorData.nwKey.substring(0, 8)}...</code></td>
                        <td><code>${sensorData.shortAddr}</code></td>
                        <td>${sensorData.bidi ? '<span class="badge bg-success">Yes</span>' : '<span class="badge bg-secondary">No</span>'}</td>
                        <td>${statusBadge}</td>
                        <td><small>${baseStationsText}</small></td>
                        <td><small>${lastActivityText}</small></td>
                        <td><small>${preferredPathText}</small></td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="editSensor('${eui}')">Edit</button>
                            <button class="btn btn-sm btn-outline-danger ms-1" onclick="deleteSensor('${eui}')">Delete</button>
                            ${sensorData.registered ? `<button class="btn btn-sm btn-warning ms-1" onclick="detachSensor('${eui}')">Detach</button>` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        });
}

function openSensorModal(sensor = null) {
    editingEui = sensor ? sensor.eui : null;
    document.getElementById('sensorModalTitle').textContent = sensor ? 'Edit Sensor' : 'Add New Sensor';

    if (sensor) {
        document.getElementById('eui').value = sensor.eui;
        document.getElementById('nwKey').value = sensor.nwKey;
        document.getElementById('shortAddr').value = sensor.shortAddr;
        document.getElementById('bidi').checked = sensor.bidi;
        document.getElementById('eui').readOnly = true;
    } else {
        document.getElementById('sensorForm').reset();
        document.getElementById('eui').readOnly = false;
    }
}

function editSensor(eui) {
    fetch('/api/sensors')
        .then(response => response.json())
        .then(sensorStatus => {
            const sensor = Object.values(sensorStatus).find(s => s.eui === eui);
            if (sensor) {
                openSensorModal(sensor);
                new bootstrap.Modal(document.getElementById('sensorModal')).show();
            }
        });
}

function saveSensor() {
    const formData = {
        eui: document.getElementById('eui').value.toUpperCase(),
        nwKey: document.getElementById('nwKey').value.toUpperCase(),
        shortAddr: document.getElementById('shortAddr').value.toUpperCase(),
        bidi: document.getElementById('bidi').checked
    };

    fetch('/api/sensors', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('sensorModal')).hide();
            loadSensors();
        } else {
            alert('Error: ' + result.message);
        }
    });
}

function deleteSensor(eui) {
    if (confirm(`Are you sure you want to delete sensor ${eui}?`)) {
        fetch(`/api/sensors/${eui}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Sensor deleted successfully', 'success');
                    loadSensors();
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('Error deleting sensor', 'error');
            });
    }
}

function detachSensor(eui) {
    if (confirm(`Are you sure you want to detach sensor ${eui} from all base stations?`)) {
        fetch(`/api/sensors/unregister/${eui}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Sensor detach request sent successfully', 'success');
                    setTimeout(loadSensors, 2000); // Reload after 2 seconds to see status change
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('Error detaching sensor', 'error');
            });
    }
}

function detachAllSensors() {
    if (confirm('Are you sure you want to detach ALL registered sensors from all base stations?')) {
        fetch('/api/sensors/unregister-all', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Detach requests sent for all sensors', 'success');
                    setTimeout(loadSensors, 3000); // Reload after 3 seconds to see status change
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('Error detaching sensors', 'error');
            });
    }
}

function reloadSensors() {
    fetch('/api/sensors/reload', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadSensors();
            alert('Sensor configuration reloaded successfully');
        } else {
            alert('Error: ' + result.message);
        }
    });
}

function clearAllSensors() {
    if (confirm('Are you sure you want to clear ALL sensor configurations? This cannot be undone!')) {
        fetch('/api/sensors/clear', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('All sensors cleared successfully', 'success');
                    loadSensors();
                } else {
                    showAlert(data.message, 'error');
                }
            })
            .catch(error => {
                showAlert('Error clearing sensors', 'error');
            });
    }
}

// Helper function for showing alerts
function showAlert(message, type) {
    const alertPlaceholder = document.createElement('div');
    alertPlaceholder.className = `alert alert-${type} alert-dismissible fade show`;
    alertPlaceholder.role = 'alert';
    alertPlaceholder.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.getElementById('sensors-table').parentNode.insertBefore(alertPlaceholder, document.getElementById('sensors-table'));
}

// Load sensors on page load
loadSensors();
</script>
{% endblock %}