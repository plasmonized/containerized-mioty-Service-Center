{% extends "base.html" %}
{% block title %}Sensors{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>Sensor Management</h1>
    <div>
        <button class="btn me-2" onclick="reloadSensors()" title="Reload sensor configuration" style="background-color: #6c757d; color: white; border-color: #6c757d;">
            Reload Config
        </button>
        <button class="btn btn-success me-2" onclick="attachAllSensors()" title="Attach all sensors to base stations">
            Attach All
        </button>
        <button class="btn btn-warning me-2" onclick="detachAllSensors()" title="Detach all sensors from base stations">
            Detach All
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#sensorModal" onclick="openSensorModal()" style="background-color: #ff8c00; border-color: #ff8c00;">
            Add New Sensor
        </button>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>EUI</th>
                        <th>Network Key</th>
                        <th>Short Address</th>
                        <th>Bidirectional</th>
                        <th>Registration Status</th>
                        <th>Activity Status</th>
                        <th>Preferred Downlink Path</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="sensors-table">
                    <!-- Sensors will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Sensor Modal -->
<div class="modal fade" id="sensorModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sensorModalTitle">Add New Sensor</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="sensorForm">
                    <div class="mb-3">
                        <label for="eui" class="form-label">EUI (16 hex characters)</label>
                        <input type="text" class="form-control" id="eui" required maxlength="16">
                    </div>
                    <div class="mb-3">
                        <label for="nwKey" class="form-label">Network Key (32 hex characters)</label>
                        <input type="text" class="form-control" id="nwKey" required maxlength="32">
                    </div>
                    <div class="mb-3">
                        <label for="shortAddr" class="form-label">Short Address (4 hex characters)</label>
                        <input type="text" class="form-control" id="shortAddr" required maxlength="4">
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="bidi">
                            <label class="form-check-label" for="bidi">
                                Bidirectional
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSensor()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let editingEui = null;

function getActivityStatusHtml(sensor) {
    const lastSeenHours = sensor.hours_since_last_seen || 0;
    
    // Handle different activity statuses
    switch(sensor.activity_status) {
        case 'auto_detached':
            const autoDetachInfo = sensor.auto_detach_info || {};
            return `<span class="badge bg-danger">Auto-Detached</span>
                    <br><small><strong>Reason:</strong> ${autoDetachInfo.reason || 'inactivity'}</small>
                    <br><small><strong>Inactive:</strong> ${autoDetachInfo.inactive_hours || 'N/A'}h</small>
                    <br><small><strong>Detached:</strong> ${autoDetachInfo.detach_time || 'N/A'}</small>`;
        
        case 'warning':
            const warningInfo = sensor.warning_info || {};
            return `<span class="badge bg-warning text-dark">⚠️ Warning</span>
                    <br><small><strong>Inactive:</strong> ${warningInfo.hours_inactive?.toFixed(1) || lastSeenHours.toFixed(1)}h</small>
                    <br><small><strong>Auto-detach in:</strong> ${warningInfo.hours_until_detach?.toFixed(1) || 'N/A'}h</small>
                    <br><small><strong>Warning sent:</strong> ${warningInfo.warning_sent ? 'Yes' : 'No'}</small>`;
        
        case 'auto_detach_pending':
            return `<span class="badge bg-danger">Detach Pending</span>
                    <br><small><strong>Inactive:</strong> ${lastSeenHours.toFixed(1)}h</small>
                    <br><small><strong>Status:</strong> Will be detached soon</small>`;
        
        case 'active':
            return `<span class="badge bg-success">Active</span>
                    <br><small><strong>Last seen:</strong> ${lastSeenHours.toFixed(1)}h ago</small>`;
        
        case 'no_data':
        default:
            // Check if sensor has data but status not set properly
            if (sensor.preferredDownlinkPath || lastSeenHours > 0) {
                // Sensor has data, should be active
                return `<span class="badge bg-success">Active</span>
                        <br><small><strong>Last seen:</strong> ${lastSeenHours > 0 ? lastSeenHours.toFixed(1) + 'h ago' : 'Recently'}</small>`;
            }
            return '<span class="badge bg-secondary">No Data</span>';
    }
}

function loadSensors() {
    fetch('/api/sensors')
        .then(response => response.json())
        .then(sensorStatus => {
            const tbody = document.getElementById('sensors-table');
            tbody.innerHTML = Object.values(sensorStatus).map(sensor => `
                <tr>
                    <td><code>${sensor.eui}</code></td>
                    <td><code>${sensor.nwKey.substring(0, 8)}...</code></td>
                    <td><code>${sensor.shortAddr}</code></td>
                    <td>${sensor.bidi ? 'Yes' : 'No'}</td>
                    <td>
                        ${(sensor.registered || sensor.preferredDownlinkPath || sensor.last_seen_timestamp > 0) ? 
                            `<span class="badge bg-success">Registered</span>
                            <br><small>Base Stations (${sensor.total_registrations || (sensor.base_stations ? sensor.base_stations.length : 0)}):</small>
                            <br><small>${sensor.base_stations && sensor.base_stations.length > 0 ? sensor.base_stations.join(', ') : 
                                (sensor.preferredDownlinkPath ? sensor.preferredDownlinkPath.baseStation : 'Active')}</small>` : 
                            '<span class="badge bg-warning">Not Registered</span>'}</td>
                    <td>${getActivityStatusHtml(sensor)}</td>
                    <td>${sensor.preferredDownlinkPath ? 
                            `<strong>BS:</strong> ${sensor.preferredDownlinkPath.baseStation}
                            <br><small><strong>SNR:</strong> ${sensor.preferredDownlinkPath.snr} dB</small>
                            <br><small><strong>Messages:</strong> ${sensor.preferredDownlinkPath.messageCount}</small>
                            <br><small><strong>Updated:</strong> ${new Date(sensor.preferredDownlinkPath.lastUpdated).toLocaleString()}</small>` : 
                            '<span class="text-muted">No data received</span>'}</td>
                    <td>
                        <button class="btn btn-sm btn-primary me-1" onclick="editSensor('${sensor.eui}')" style="background-color: #ff8c00; border-color: #ff8c00;">
                            Edit
                        </button>
                        <button class="btn btn-sm btn-warning me-1" onclick="detachSensor('${sensor.eui}')" title="Detach from all base stations">
                            Detach
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteSensor('${sensor.eui}')">
                            Delete
                        </button>
                    </td>
                </tr>
            `).join('');
        });
}

function openSensorModal(sensor = null) {
    editingEui = sensor ? sensor.eui : null;
    document.getElementById('sensorModalTitle').textContent = sensor ? 'Edit Sensor' : 'Add New Sensor';

    if (sensor) {
        document.getElementById('eui').value = sensor.eui;
        document.getElementById('nwKey').value = sensor.nwKey;
        document.getElementById('shortAddr').value = sensor.shortAddr;
        document.getElementById('bidi').checked = sensor.bidi;
        document.getElementById('eui').readOnly = true;
    } else {
        document.getElementById('sensorForm').reset();
        document.getElementById('eui').readOnly = false;
    }
}

function editSensor(eui) {
    fetch('/api/sensors')
        .then(response => response.json())
        .then(sensorStatus => {
            const sensor = Object.values(sensorStatus).find(s => s.eui === eui);
            if (sensor) {
                openSensorModal(sensor);
                new bootstrap.Modal(document.getElementById('sensorModal')).show();
            }
        });
}

function saveSensor() {
    const formData = {
        eui: document.getElementById('eui').value.toUpperCase(),
        nwKey: document.getElementById('nwKey').value.toUpperCase(),
        shortAddr: document.getElementById('shortAddr').value.toUpperCase(),
        bidi: document.getElementById('bidi').checked
    };

    fetch('/api/sensors', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            bootstrap.Modal.getInstance(document.getElementById('sensorModal')).hide();
            loadSensors();
        } else {
            alert('Error: ' + result.message);
        }
    });
}

function detachSensor(eui) {
        if (confirm(`Are you sure you want to detach sensor ${eui} from all base stations?`)) {
            fetch(`/api/sensors/${eui}/detach`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    loadSensors();
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', 'Error detaching sensor: ' + error.message);
            });
        }
    }

    function deleteSensor(eui) {
        if (confirm(`Are you sure you want to delete sensor ${eui}?`)) {
            fetch(`/api/sensors/${eui}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    loadSensors();
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', 'Error deleting sensor: ' + error.message);
            });
        }
    }

function reloadSensors() {
    fetch('/api/sensors/reload', {
        method: 'POST'
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadSensors();
            alert('Sensor configuration reloaded successfully');
        } else {
            alert('Error: ' + result.message);
        }
    });
}

function attachAllSensors() {
    if (confirm('Are you sure you want to attach ALL configured sensors to base stations?')) {
        fetch('/api/sensors/attach-all', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                loadSensors();
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'Error attaching sensors: ' + error.message);
        });
    }
}

function detachAllSensors() {
    if (confirm('Are you sure you want to detach ALL sensors from base stations? This will not delete the sensor configurations.')) {
        fetch('/api/sensors/detach-all', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('success', data.message);
                loadSensors();
            } else {
                showAlert('danger', data.message);
            }
        })
        .catch(error => {
            showAlert('danger', 'Error detaching sensors: ' + error.message);
        });
    }
}

function clearAllSensors() {
        if (confirm('Are you sure you want to clear ALL sensors? This will detach all sensors from base stations and remove all configurations. This action cannot be undone.')) {
            fetch('/api/sensors/clear', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', data.message);
                    loadSensors();
                } else {
                    showAlert('danger', data.message);
                }
            })
            .catch(error => {
                showAlert('danger', 'Error clearing sensors: ' + error.message);
            });
        }
    }

// Load sensors on page load
loadSensors();
</script>
{% endblock %}