{% extends "base.html" %}
{% block title %}Configuration{% endblock %}

{% block content %}
<h1>Configuration</h1>

<div class="card">
    <div class="card-header">
        <h5>MQTT and Server Settings</h5>
    </div>
    <div class="card-body">
        <form id="configForm">
            <div class="row">
                <div class="col-md-6">
                    <h6>Server Configuration</h6>
                    <div class="mb-3">
                        <label for="LISTEN_HOST" class="form-label">Listen Host</label>
                        <input type="text" class="form-control" id="LISTEN_HOST" value="{{ config.LISTEN_HOST }}">
                    </div>
                    <div class="mb-3">
                        <label for="LISTEN_PORT" class="form-label">Listen Port</label>
                        <input type="number" class="form-control" id="LISTEN_PORT" value="{{ config.LISTEN_PORT }}">
                    </div>
                    <div class="mb-3">
                        <label for="STATUS_INTERVAL" class="form-label">Status Interval (seconds)</label>
                        <input type="number" class="form-control" id="STATUS_INTERVAL" value="{{ config.STATUS_INTERVAL }}">
                    </div>
                    <div class="mb-3">
                        <label for="DEDUPLICATION_DELAY" class="form-label">Message Deduplication Delay (seconds)</label>
                        <input type="number" step="0.1" min="0.5" max="10" class="form-control" id="DEDUPLICATION_DELAY" value="{{ config.DEDUPLICATION_DELAY }}">
                        <div class="form-text">Time to wait for duplicate messages before forwarding the best one (0.5-10 seconds)</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h6>MQTT Configuration</h6>
                    <div class="mb-3">
                        <label for="MQTT_BROKER" class="form-label">MQTT Broker</label>
                        <input type="text" class="form-control" id="MQTT_BROKER" value="{{ config.MQTT_BROKER }}">
                    </div>
                    <div class="mb-3">
                        <label for="MQTT_PORT" class="form-label">MQTT Port</label>
                        <input type="number" class="form-control" id="MQTT_PORT" value="{{ config.MQTT_PORT }}">
                    </div>
                    <div class="mb-3">
                        <label for="MQTT_USERNAME" class="form-label">MQTT Username</label>
                        <input type="text" class="form-control" id="MQTT_USERNAME" value="{{ config.MQTT_USERNAME }}">
                    </div>
                    <div class="mb-3">
                        <label for="MQTT_PASSWORD" class="form-label">MQTT Password</label>
                        <input type="password" class="form-control" id="MQTT_PASSWORD" value="{{ config.MQTT_PASSWORD }}">
                    </div>
                    <div class="mb-3">
                        <label for="BASE_TOPIC" class="form-label">Base Topic</label>
                        <input type="text" class="form-control" id="BASE_TOPIC" value="{{ config.BASE_TOPIC }}">
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Auto-Detach Configuration</h5>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="AUTO_DETACH_ENABLED" {% if config.AUTO_DETACH_ENABLED %}checked{% endif %}>
                            <label class="form-check-label" for="AUTO_DETACH_ENABLED">
                                Enable Auto-Detach
                            </label>
                        </div>
                        <div class="form-text">Automatically detach sensors after period of inactivity</div>
                    </div>

                    <div class="mb-3">
                        <label for="AUTO_DETACH_TIMEOUT" class="form-label">Auto-Detach Timeout (hours)</label>
                        <input type="number" class="form-control" id="AUTO_DETACH_TIMEOUT" value="{{ config.AUTO_DETACH_TIMEOUT // 3600 }}" min="1">
                        <div class="form-text">Hours of inactivity before auto-detach (default: 72 hours)</div>
                    </div>

                    <div class="mb-3">
                        <label for="AUTO_DETACH_WARNING_TIMEOUT" class="form-label">Warning Timeout (hours)</label>
                        <input type="number" class="form-control" id="AUTO_DETACH_WARNING_TIMEOUT" value="{{ config.AUTO_DETACH_WARNING_TIMEOUT // 3600 }}" min="1">
                        <div class="form-text">Hours of inactivity before warning (default: 36 hours)</div>
                    </div>

                    <div class="mb-3">
                        <label for="AUTO_DETACH_CHECK_INTERVAL" class="form-label">Check Interval (hours)</label>
                        <input type="number" class="form-control" id="AUTO_DETACH_CHECK_INTERVAL" value="{{ config.AUTO_DETACH_CHECK_INTERVAL // 3600 }}" min="1">
                        <div class="form-text">How often to check for inactive sensors (default: 1 hour)</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h5>System Updates</h5>
                    <div class="card">
                        <div class="card-body">
                            <div id="updateStatus" class="mb-3">
                                <p class="text-muted">Loading version information...</p>
                            </div>
                            
                            <div class="mb-3">
                                <button type="button" class="btn btn-info btn-sm" onclick="checkForUpdates()">
                                    <i class="fas fa-sync-alt"></i> Check for Updates
                                </button>
                                <button type="button" class="btn btn-success btn-sm ms-2" id="updateBtn" onclick="performUpdate()" disabled>
                                    <i class="fas fa-download"></i> Install Update
                                </button>
                            </div>
                            
                            <div id="updateDetails" class="d-none">
                                <h6>Recent Changes:</h6>
                                <ul id="commitList" class="list-unstyled small">
                                    <!-- Commits will be loaded here -->
                                </ul>
                            </div>
                            
                            <div id="updateProgress" class="d-none">
                                <div class="progress mb-2">
                                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                                </div>
                                <p class="text-info small">Update in progress...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
                <button type="button" class="btn btn-warning ms-2" onclick="restartService()">Restart Service</button>
                <button type="button" class="btn btn-danger ms-2" onclick="restartContainer()">Restart Container</button>
                <div class="alert alert-warning mt-3">
                    <small><strong>Note:</strong> Configuration changes require a restart to take effect. Use "Restart Service" for quick process restart, or "Restart Container" for full environment reload (recommended after changing MQTT credentials or other .env variables).</small>
                </div>
            </div></div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function saveConfig() {
    const configData = {
        LISTEN_HOST: document.getElementById('LISTEN_HOST').value,
        LISTEN_PORT: parseInt(document.getElementById('LISTEN_PORT').value),
        MQTT_BROKER: document.getElementById('MQTT_BROKER').value,
        MQTT_PORT: parseInt(document.getElementById('MQTT_PORT').value),
        MQTT_USERNAME: document.getElementById('MQTT_USERNAME').value,
        MQTT_PASSWORD: document.getElementById('MQTT_PASSWORD').value,
        BASE_TOPIC: document.getElementById('BASE_TOPIC').value,
        STATUS_INTERVAL: parseInt(document.getElementById('STATUS_INTERVAL').value),
        DEDUPLICATION_DELAY: parseFloat(document.getElementById('DEDUPLICATION_DELAY').value),
        AUTO_DETACH_ENABLED: document.getElementById('AUTO_DETACH_ENABLED').checked,
        AUTO_DETACH_TIMEOUT: parseInt(document.getElementById('AUTO_DETACH_TIMEOUT').value) * 3600,
        AUTO_DETACH_WARNING_TIMEOUT: parseInt(document.getElementById('AUTO_DETACH_WARNING_TIMEOUT').value) * 3600,
        AUTO_DETACH_CHECK_INTERVAL: parseInt(document.getElementById('AUTO_DETACH_CHECK_INTERVAL').value) * 3600
    };

    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(configData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Configuration saved successfully! Please restart the service for changes to take effect.');
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error saving configuration: ' + error);
    });
}

function restartService() {
    if (confirm('Are you sure you want to restart the BSSCI service? This will briefly interrupt connections.')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Restarting...';

        fetch('/api/service/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Service restart initiated successfully! Please wait a few seconds for the service to come back online.');
            } else {
                alert('Error restarting service: ' + result.message);
            }
        })
        .catch(error => {
            alert('Error restarting service: ' + error);
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

function restartContainer() {
    if (confirm('Are you sure you want to restart the entire container? This will fully restart the application and reload all environment variables. The service will be unavailable for about 10-15 seconds.')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Restarting Container...';

        fetch('/api/container/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Container restart initiated successfully! The page will reload automatically in 15 seconds to reconnect.');
                // Reload the page after 15 seconds to reconnect
                setTimeout(() => {
                    window.location.reload();
                }, 15000);
            } else {
                alert('Error restarting container: ' + result.message);
            }
        })
        .catch(error => {
            alert('Container restart initiated. The page will reload in 15 seconds.');
            // Even if the fetch fails (expected since container is restarting), reload the page
            setTimeout(() => {
                window.location.reload();
            }, 15000);
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}

// Update Management Functions
let currentVersionInfo = null;

function loadVersionInfo() {
    fetch('/api/system/version')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            currentVersionInfo = data;
            displayVersionInfo(data);
        })
        .catch(error => {
            console.error('Version API Error:', error);
            document.getElementById('updateStatus').innerHTML = 
                '<p class="text-danger">⚠️ Cannot connect to update API<br>' +
                '<small>Error: ' + error.message + '<br>' +
                'This may be a network connectivity issue.</small></p>';
            
            // Disable update button
            document.getElementById('updateBtn').disabled = true;
        });
}

function displayVersionInfo(data) {
    const statusDiv = document.getElementById('updateStatus');
    
    if (data.error) {
        statusDiv.innerHTML = '<p class="text-danger">Error: ' + data.error + '</p>';
        return;
    }
    
    const statusClass = data.updates_available ? 'text-warning' : 'text-success';
    const statusText = data.updates_available ? 'Update Available!' : 'Up to Date';
    const updateIcon = data.updates_available ? '🔄' : '✅';
    
    statusDiv.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-2">
            <strong class="${statusClass}">${updateIcon} ${statusText}</strong>
        </div>
        <div class="small text-muted">
            <div><strong>Current:</strong> ${data.current_version}</div>
            <div><strong>Latest:</strong> ${data.remote_version}</div>
        </div>
    `;
    
    // Enable/disable update button
    const updateBtn = document.getElementById('updateBtn');
    updateBtn.disabled = !data.updates_available;
    
    // Show recent commits if available
    if (data.recent_commits && data.recent_commits.length > 0) {
        const commitList = document.getElementById('commitList');
        commitList.innerHTML = '';
        
        data.recent_commits.slice(0, 3).forEach(commit => {
            const li = document.createElement('li');
            li.innerHTML = `<code>${commit.hash}</code> ${commit.message}`;
            commitList.appendChild(li);
        });
        
        document.getElementById('updateDetails').classList.remove('d-none');
    }
}

function checkForUpdates() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Checking...';
    
    fetch('/api/system/check-updates')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            currentVersionInfo = data;
            displayVersionInfo(data);
            
            if (data.updates_available) {
                alert('New update available! Current: ' + data.current_version + ', Latest: ' + data.remote_version);
            } else {
                alert('System is up to date! Current version: ' + data.current_version);
            }
        })
        .catch(error => {
            console.error('Update check error:', error);
            alert('Error checking for updates: ' + error.message + 
                  '\n\nThis may be a network connectivity issue. Please check if you can access the service API.');
        })
        .finally(() => {
            button.disabled = false;
            button.innerHTML = originalText;
        });
}

function performUpdate() {
    if (!currentVersionInfo || !currentVersionInfo.updates_available) {
        alert('No updates available');
        return;
    }
    
    if (!confirm('Are you sure you want to update the system? This will:\n\n' +
                 '1. Create a backup of your configuration\n' +
                 '2. Download and install the latest version\n' +
                 '3. Restart the service\n\n' +
                 'The service will be unavailable for about 30-60 seconds.')) {
        return;
    }
    
    const button = document.getElementById('updateBtn');
    const originalText = button.innerHTML;
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
    
    // Show progress
    document.getElementById('updateProgress').classList.remove('d-none');
    
    fetch('/api/system/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        document.getElementById('updateProgress').classList.add('d-none');
        
        if (result.success) {
            alert('Update completed successfully!\\n\\nBackup created: ' + result.backup_dir + '\\n\\nThe service will restart automatically.');
            
            // Auto-restart after successful update
            setTimeout(() => {
                restartSystemAfterUpdate();
            }, 2000);
        } else {
            alert('Update failed: ' + result.error + (result.backup_dir ? '\\n\\nBackup created: ' + result.backup_dir : ''));
        }
    })
    .catch(error => {
        document.getElementById('updateProgress').classList.add('d-none');
        alert('Update error: ' + error);
    })
    .finally(() => {
        button.disabled = false;
        button.innerHTML = originalText;
    });
}

function restartSystemAfterUpdate() {
    fetch('/api/system/restart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(result => {
        alert('System restart initiated. The page will reload automatically in 10 seconds.');
        setTimeout(() => {
            window.location.reload();
        }, 10000);
    })
    .catch(error => {
        alert('Update completed but restart failed. Please restart manually. Error: ' + error);
    });
}

// Load version info when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadVersionInfo();
});
</script>
{% endblock %}