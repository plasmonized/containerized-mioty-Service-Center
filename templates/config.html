{% extends "base.html" %}
{% block title %}Configuration{% endblock %}

{% block content %}
<h1>Configuration</h1>

<div class="card">
    <div class="card-header">
        <h5>MQTT and Server Settings</h5>
    </div>
    <div class="card-body">
        <form id="configForm">
            <div class="row">
                <div class="col-md-6">
                    <h6>Server Configuration</h6>
                    <div class="mb-3">
                        <label for="LISTEN_HOST" class="form-label">Listen Host</label>
                        <input type="text" class="form-control" id="LISTEN_HOST" value="{{ config.LISTEN_HOST }}">
                    </div>
                    <div class="mb-3">
                        <label for="LISTEN_PORT" class="form-label">Listen Port</label>
                        <input type="number" class="form-control" id="LISTEN_PORT" value="{{ config.LISTEN_PORT }}">
                    </div>
                    <div class="mb-3">
                        <label for="STATUS_INTERVAL" class="form-label">Status Interval (seconds)</label>
                        <input type="number" class="form-control" id="STATUS_INTERVAL" value="{{ config.STATUS_INTERVAL }}">
                    </div>
                    <div class="mb-3">
                        <label for="DEDUPLICATION_DELAY" class="form-label">Message Deduplication Delay (seconds)</label>
                        <input type="number" step="0.1" min="0.5" max="10" class="form-control" id="DEDUPLICATION_DELAY" value="{{ config.DEDUPLICATION_DELAY }}">
                        <div class="form-text">Time to wait for duplicate messages before forwarding the best one (0.5-10 seconds)</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h6>MQTT Configuration</h6>
                    <div class="mb-3">
                        <label for="MQTT_BROKER" class="form-label">MQTT Broker</label>
                        <input type="text" class="form-control" id="MQTT_BROKER" value="{{ config.MQTT_BROKER }}">
                    </div>
                    <div class="mb-3">
                        <label for="MQTT_PORT" class="form-label">MQTT Port</label>
                        <input type="number" class="form-control" id="MQTT_PORT" value="{{ config.MQTT_PORT }}">
                    </div>
                    <div class="mb-3">
                        <label for="MQTT_USERNAME" class="form-label">MQTT Username</label>
                        <input type="text" class="form-control" id="MQTT_USERNAME" value="{{ config.MQTT_USERNAME }}">
                    </div>
                    <div class="mb-3">
                        <label for="MQTT_PASSWORD" class="form-label">MQTT Password</label>
                        <input type="password" class="form-control" id="MQTT_PASSWORD" value="{{ config.MQTT_PASSWORD }}">
                    </div>
                    <div class="mb-3">
                        <label for="BASE_TOPIC" class="form-label">Base Topic</label>
                        <input type="text" class="form-control" id="BASE_TOPIC" value="{{ config.BASE_TOPIC }}">
                    </div>
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Auto-Detach Configuration</h5>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="AUTO_DETACH_ENABLED" {% if config.AUTO_DETACH_ENABLED %}checked{% endif %}>
                            <label class="form-check-label" for="AUTO_DETACH_ENABLED">
                                Enable Auto-Detach
                            </label>
                        </div>
                        <div class="form-text">Automatically detach sensors after period of inactivity</div>
                    </div>

                    <div class="mb-3">
                        <label for="AUTO_DETACH_TIMEOUT" class="form-label">Auto-Detach Timeout (hours)</label>
                        <input type="number" class="form-control" id="AUTO_DETACH_TIMEOUT" value="{{ config.AUTO_DETACH_TIMEOUT // 3600 }}" min="1">
                        <div class="form-text">Hours of inactivity before auto-detach (default: 72 hours)</div>
                    </div>

                    <div class="mb-3">
                        <label for="AUTO_DETACH_WARNING_TIMEOUT" class="form-label">Warning Timeout (hours)</label>
                        <input type="number" class="form-control" id="AUTO_DETACH_WARNING_TIMEOUT" value="{{ config.AUTO_DETACH_WARNING_TIMEOUT // 3600 }}" min="1">
                        <div class="form-text">Hours of inactivity before warning (default: 36 hours)</div>
                    </div>

                    <div class="mb-3">
                        <label for="AUTO_DETACH_CHECK_INTERVAL" class="form-label">Check Interval (hours)</label>
                        <input type="number" class="form-control" id="AUTO_DETACH_CHECK_INTERVAL" value="{{ config.AUTO_DETACH_CHECK_INTERVAL // 3600 }}" min="1">
                        <div class="form-text">How often to check for inactive sensors (default: 1 hour)</div>
                    </div>
                </div>
            </div>



            <div class="mt-3">
                <button type="button" class="btn btn-primary" onclick="saveConfig()">Save Configuration</button>
                <button type="button" class="btn btn-warning ms-2" onclick="restartService()">Restart Service</button>
                <div class="alert alert-warning mt-3">
                    <small><strong>Note:</strong> Changes require a service restart to take effect.</small>
                </div>
            </div></div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function saveConfig() {
    const configData = {
        LISTEN_HOST: document.getElementById('LISTEN_HOST').value,
        LISTEN_PORT: parseInt(document.getElementById('LISTEN_PORT').value),
        MQTT_BROKER: document.getElementById('MQTT_BROKER').value,
        MQTT_PORT: parseInt(document.getElementById('MQTT_PORT').value),
        MQTT_USERNAME: document.getElementById('MQTT_USERNAME').value,
        MQTT_PASSWORD: document.getElementById('MQTT_PASSWORD').value,
        BASE_TOPIC: document.getElementById('BASE_TOPIC').value,
        STATUS_INTERVAL: parseInt(document.getElementById('STATUS_INTERVAL').value),
        DEDUPLICATION_DELAY: parseFloat(document.getElementById('DEDUPLICATION_DELAY').value),
        AUTO_DETACH_ENABLED: document.getElementById('AUTO_DETACH_ENABLED').checked,
        AUTO_DETACH_TIMEOUT: parseInt(document.getElementById('AUTO_DETACH_TIMEOUT').value) * 3600,
        AUTO_DETACH_WARNING_TIMEOUT: parseInt(document.getElementById('AUTO_DETACH_WARNING_TIMEOUT').value) * 3600,
        AUTO_DETACH_CHECK_INTERVAL: parseInt(document.getElementById('AUTO_DETACH_CHECK_INTERVAL').value) * 3600
    };

    fetch('/api/config', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(configData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            alert('Configuration saved successfully! Please restart the service for changes to take effect.');
        } else {
            alert('Error: ' + result.message);
        }
    })
    .catch(error => {
        alert('Error saving configuration: ' + error);
    });
}

function restartService() {
    if (confirm('Are you sure you want to restart the BSSCI service? This will briefly interrupt connections.')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Restarting...';

        fetch('/api/service/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Service restart initiated successfully! Please wait a few seconds for the service to come back online.');
            } else {
                alert('Error restarting service: ' + result.message);
            }
        })
        .catch(error => {
            alert('Error restarting service: ' + error);
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}
</script>
{% endblock %}