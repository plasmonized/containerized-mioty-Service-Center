{% extends "base.html" %}
{% block title %}Configuration{% endblock %}

{% block content %}
<h1>Configuration</h1>

<div class="card">
    <div class="card-header">
        <h5>MQTT and Server Settings</h5>
    </div>
    <div class="card-body">
        <form id="configForm">
            <div class="row">
                <div class="col-md-6">
                    <h6>Server Configuration</h6>
                    <div class="mb-3">
                        <label for="listen_host" class="form-label">Listen Host</label>
                        <input type="text" class="form-control" id="listen_host" value="{{ config.listen_host }}">
                    </div>
                    <div class="mb-3">
                        <label for="listen_port" class="form-label">Listen Port</label>
                        <input type="number" class="form-control" id="listen_port" value="{{ config.listen_port }}">
                    </div>
                    <div class="mb-3">
                        <label for="status_interval" class="form-label">Status Interval (seconds)</label>
                        <input type="number" class="form-control" id="status_interval" value="{{ config.status_interval }}">
                    </div>
                    <div class="mb-3">
                        <label for="deduplication_delay" class="form-label">Message Deduplication Delay (seconds)</label>
                        <input type="number" step="0.1" min="0.5" max="10" class="form-control" id="deduplication_delay" value="{{ config.deduplication_delay }}">
                        <div class="form-text">Time to wait for duplicate messages before forwarding the best one (0.5-10 seconds)</div>
                    </div>
                    <div class="mb-3">
                        <label for="auto_detach_hours" class="form-label">Auto-Detach Hours</label>
                        <input type="number" min="1" max="168" class="form-control" id="auto_detach_hours" value="{{ config.auto_detach_hours }}">
                        <div class="form-text">Hours of inactivity before automatically detaching sensors (1-168 hours)</div>
                    </div>
                    <div class="mb-3">
                        <label for="auto_detach_check_interval" class="form-label">Auto-Detach Check Interval (seconds)</label>
                        <input type="number" min="300" max="86400" class="form-control" id="auto_detach_check_interval" value="{{ config.auto_detach_check_interval }}">
                        <div class="form-text">Interval between auto-detach checks (300-86400 seconds)</div>
                    </div>
                </div>

                <div class="col-md-6">
                    <h6>MQTT Configuration</h6>
                    <div class="mb-3">
                        <label for="mqtt_broker" class="form-label">MQTT Broker</label>
                        <input type="text" class="form-control" id="mqtt_broker" value="{{ config.mqtt_broker }}">
                    </div>
                    <div class="mb-3">
                        <label for="mqtt_port" class="form-label">MQTT Port</label>
                        <input type="number" class="form-control" id="mqtt_port" value="{{ config.mqtt_port }}">
                    </div>
                    <div class="mb-3">
                        <label for="mqtt_username" class="form-label">MQTT Username</label>
                        <input type="text" class="form-control" id="mqtt_username" value="{{ config.mqtt_username }}">
                    </div>
                    <div class="mb-3">
                        <label for="mqtt_password" class="form-label">MQTT Password</label>
                        <input type="password" class="form-control" id="mqtt_password" value="{{ config.mqtt_password }}">
                    </div>
                    <div class="mb-3">
                        <label for="base_topic" class="form-label">Base Topic</label>
                        <input type="text" class="form-control" id="base_topic" value="{{ config.base_topic }}">
                    </div>
                </div>
            </div>
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg" onclick="saveConfiguration()">
                    Save Configuration
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function saveConfiguration() {
    const formData = new FormData();
    formData.append('mqtt_broker', document.getElementById('mqtt_broker').value);
    formData.append('mqtt_port', document.getElementById('mqtt_port').value);
    formData.append('mqtt_username', document.getElementById('mqtt_username').value);
    formData.append('mqtt_password', document.getElementById('mqtt_password').value);
    formData.append('base_topic', document.getElementById('base_topic').value);
    formData.append('listen_host', document.getElementById('listen_host').value);
    formData.append('listen_port', document.getElementById('listen_port').value);
    formData.append('status_interval', document.getElementById('status_interval').value);
    formData.append('deduplication_delay', document.getElementById('deduplication_delay').value);
    formData.append('auto_detach_hours', document.getElementById('auto_detach_hours').value);
    formData.append('auto_detach_check_interval', document.getElementById('auto_detach_check_interval').value);


    fetch('/config', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            alert('Configuration saved successfully! Restart required for changes to take effect.');
        } else {
            alert('Error saving configuration: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error saving configuration: ' + error);
    });
}

function restartService() {
    if (confirm('Are you sure you want to restart the BSSCI service? This will briefly interrupt connections.')) {
        const button = event.target;
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Restarting...';

        fetch('/api/service/restart', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                alert('Service restart initiated successfully! Please wait a few seconds for the service to come back online.');
            } else {
                alert('Error restarting service: ' + result.message);
            }
        })
        .catch(error => {
            alert('Error restarting service: ' + error);
        })
        .finally(() => {
            button.disabled = false;
            button.textContent = originalText;
        });
    }
}
</script>
{% endblock %}